---
title: "Data Analysis"
subtitle: "Comprehensive Data Cleaning & Exploratory Analysis of Job Market Trends"
author:
  - name: Yibei Yu, Fuhan Zhang, Jonathan Leon
    affiliations:
      - id: bu
        name: Boston University
        city: Boston
        state: MA
bibliography: references.bib
csl: csl/econometrica.csl
format: 
  html:
    toc: true
    number-sections: true
    df-print: paged
---
```{python}
import pandas as pd
import missingno as msno
import matplotlib.pyplot as plt
import numpy as np
import os
from IPython.display import display
import seaborn as sns
sns.set_theme(style="whitegrid")

os.makedirs("figures", exist_ok=True)

df = pd.read_csv("data/lightcast_job_postings.csv")
print("Columns in dataset:", df.columns.tolist())

# drop irrelevant columns
columns_to_drop = [
    "ID", "URL", "ACTIVE_URLS", "DUPLICATES", "LAST_UPDATED_TIMESTAMP",
    "NAICS2", "NAICS3", "NAICS4", "NAICS5", "NAICS6",
    "SOC_2", "SOC_3", "SOC_5"
]
df.drop(columns=columns_to_drop, inplace=True, errors="ignore")

# Missing values heatmap
plt.figure(figsize=(10,6))
msno.heatmap(df)
plt.title("Missing Values Heatmap")
plt.tight_layout()
plt.savefig("figures/missing_values_heatmap.png", dpi=300, bbox_inches="tight")
display(plt.gcf())
plt.close()

salary_related = ["SALARY", "Salary", "Average_Salary", "AVERAGE_SALARY", "SALARY_FROM", "SALARY_TO"]
thresh = len(df) * 0.5
df = df.loc[:, (df.notna().sum() >= thresh) | (df.columns.isin(salary_related))]

# numeric vs categorical cleaning
num_cols = df.select_dtypes(include=[np.number]).columns.tolist()
cat_cols = [c for c in df.columns if c not in num_cols]
for c in num_cols:
    df[c] = pd.to_numeric(df[c], errors="coerce")
df[num_cols] = df[num_cols].fillna(df[num_cols].median())
for c in cat_cols:
    df[c] = df[c].fillna("Unknown")

if "SALARY_FROM" in df.columns and "SALARY_TO" in df.columns:
    df["AVG_SALARY"] = (
        pd.to_numeric(df["SALARY_FROM"], errors="coerce") +
        pd.to_numeric(df["SALARY_TO"], errors="coerce")
    ) / 2

salary_candidates = ["AVG_SALARY", "SALARY", "Salary", "Average_Salary", "AVERAGE_SALARY"]
salary_col = next((c for c in salary_candidates if c in df.columns), None)

if salary_col:
    df[salary_col] = pd.to_numeric(df[salary_col], errors="coerce")
    q1, q3 = df[salary_col].quantile([0.25, 0.75])
    iqr = q3 - q1
    lo, hi = q1 - 1.5*iqr, q3 + 1.5*iqr
    df[salary_col] = df[salary_col].clip(lower=lo, upper=hi)

print("Detected salary_col:", salary_col)

dup_keys = [c for c in ["TITLE", "COMPANY", "LOCATION", "POSTED"] if c in df.columns]
if dup_keys:
    before = len(df)
    df = df.drop_duplicates(subset=dup_keys, keep="first")
    after = len(df)
    print(f"Removed duplicates: {before - after}")
else:
    df = df.drop_duplicates()

```